<html>
<head>

<title>Twinkle</title>

<script src="utils.js" type="text/javascript"></script>
<script src="smart-object.js" type="text/javascript"></script>
<script src="state-monad.js" type="text/javascript"></script>
<script src="entities.js" type="text/javascript"></script>
<script src="rect.js" type="text/javascript"></script>
<script src="point.js" type="text/javascript"></script>
<script src="size.js" type="text/javascript"></script>
<script src="geometry.js" type="text/javascript"></script>
<script src="ui-utils.js" type="text/javascript"></script>
<script src="movement.js" type="text/javascript"></script>
<script src="button.js" type="text/javascript"></script>
<script src="colors.js" type="text/javascript"></script>
<script src="sound.js" type="text/javascript"></script>
<script src="text-helpers.js" type="text/javascript"></script>
<script src="screen.js" type="text/javascript"></script>
<script src="time.js" type="text/javascript"></script>
<script src="component-system.js" type="text/javascript"></script>

<script src="animation-system.js" type="text/javascript"></script>
<script src="highlight-system.js" type="text/javascript"></script>
<script src="button-system.js" type="text/javascript"></script>
<script src="connector-system.js" type="text/javascript"></script>
<script src="movement-system.js" type="text/javascript"></script>

<script src="default-state.js" type="text/javascript"></script>
<script src="menu-state.js" type="text/javascript"></script>
<script src="help-state.js" type="text/javascript"></script>
<script src="game-state.js" type="text/javascript"></script>
<script src="end-game-state.js" type="text/javascript"></script>
<script src="final-state.js" type="text/javascript"></script>

<script src="game-screen.js" type="text/javascript"></script>

<script src="seedrandom-master/seedrandom.min.js" type="text/javascript"></script>

<script>

window.requestAnimFrame = (function(callback){
	return window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function(callback){
		window.setTimeout(callback, 1000 / 60);
	};
})();

function getMousePos(canvas, evt) {
	var rect = canvas.getBoundingClientRect();
	return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
}

function onload() {
	var canvas = document.getElementById('mainCanvas');
	var context = canvas.getContext('2d');

	Sound.init({
		connect: {
			sources: [
				{ url: 'sounds/connect-2.wav' },
				{ url: 'sounds/connect-3.wav' },
			],
			volume: 0.15
		},
		select: {
			sources: [
				{ url: 'sounds/select-1.wav' }
			],
			volume: 0.3
		},
		win: {
			sources: [
				{ url: 'sounds/win.wav' }
			],
			volume: 0.15
		},
		lose: {
			sources: [
				{ url: 'sounds/lose.wav' }
			],
			volume: 0.15
		},
		background: {
			sources: [
				{ url: 'music/background1.ogg', volume: 0.15 },
				{ url: 'music/background2.ogg', volume: 0.3 }
			],
			loop: true,
			onEnded: 'background'
		}
	});

	Math.seedrandom();

	Sound.play('background');

	var screen = GameScreen.init(canvas, {score: 0}, {starCount: 3, seed: 10});

	canvas.addEventListener('mousedown', function(event) {
		screen = Screen.onMouseDown(screen, getMousePos(canvas, event));
	}, false);
	document.addEventListener('mouseup', function(event) {
		screen = Screen.onMouseUp(screen, getMousePos(canvas, event));
	}, false);
	canvas.addEventListener('mousemove', function(event) {
		screen = Screen.onMouseMove(screen, getMousePos(canvas, event));
	}, false);

	var lastTime = Time.now();

	var gradient = context.createLinearGradient(0, -5 * canvas.height, 0, canvas.height);
	gradient.addColorStop(0, Colors.BACKGROUND.primary);
	gradient.addColorStop(1, Colors.BACKGROUND.secondary);

	var animate = function() {
		var time = Time.now();
		var deltaTime = time - lastTime;
		lastTime = time;

		context.fillStyle = gradient;
		context.fillRect(0, 0, canvas.width, canvas.height);

		screen = Screen.update(screen, deltaTime * 0.001, time * 0.001);
		Screen.draw(screen, context);

		requestAnimFrame(animate);
	};
	animate();
}

</script>
</head>
<body onload="onload();">
	<canvas id="mainCanvas" width="800" height="600" style="border-width:10px"></canvas>
</body>
</html>